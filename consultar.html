<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consultar Cita - Dra. Jaznelly Lesso Zamora</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap');

    * {
      font-family: 'DM Sans', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: #f8fafc;
    }

    h1,
    h2,
    h3 {
      font-family: 'Playfair Display', serif;
    }

    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
    }

    .card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
      font-weight: 600;
      padding: 14px 28px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
      background: white;
      color: #475569;
      font-weight: 600;
      padding: 14px 28px;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      border-color: #cbd5e1;
      background: #f8fafc;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
      font-weight: 600;
      padding: 14px 28px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-2px);
    }

    nav {
      backdrop-filter: blur(20px) saturate(180%);
      background: rgba(255, 255, 255, 0.9);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.05);
    }

    input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .folio-display {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 2px solid #3b82f6;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }

    .folio-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e40af;
      font-family: 'DM Sans', monospace;
      letter-spacing: 1px;
    }

    .info-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #eff6ff, #dbeafe);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }

    .info-icon:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.2);
    }

    .icon-user {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
    }

    .icon-calendar {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
    }

    .icon-hospital {
      background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
    }

    .icon-money {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
    }

    .icon-note {
      background: linear-gradient(135deg, #fce7f3, #fbcfe8);
    }

    .icon-phone {
      background: linear-gradient(135deg, #ccfbf1, #99f6e4);
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="bg-white border-b sticky top-0 z-50">
    <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
      <div>
        <h1 class="text-lg font-bold text-gray-900">Dra. Jaznelly Lesso Zamora</h1>
        <p class="text-xs text-gray-500">Oftalmolog√≠a</p>
      </div>
      <div class="flex gap-3">
        <a href="index.html" class="text-sm text-gray-600 font-semibold hover:text-gray-900">Inicio</a>
        <a href="agendar.html" class="text-sm text-blue-600 font-semibold hover:text-blue-700">Agendar</a>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6 pb-24">

    <!-- Formulario de b√∫squeda -->
    <div id="busquedaCita" class="card p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-900 mb-2">Consultar mi cita</h2>
      <p class="text-gray-600 mb-6">Busca tu cita con tu tel√©fono o folio de confirmaci√≥n</p>

      <form id="formBuscarCita" class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Tel√©fono (10 d√≠gitos)</label>
          <input type="tel" id="inputTelefonoBuscar" maxlength="10" pattern="[0-9]{10}"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg" placeholder="4491234567">
        </div>

        <div class="text-center text-sm text-gray-500 font-semibold">O</div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Folio de confirmaci√≥n</label>
          <input type="text" id="inputFolio" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg font-mono"
            placeholder="250117-143025456">
        </div>

        <button type="submit" class="btn-primary w-full flex items-center justify-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <span>Buscar mi cita</span>
        </button>
      </form>
    </div>

    <!-- Resultados -->
    <div id="resultadoCita" class="hidden">

      <!-- Sin citas -->
      <div id="sinCitas" class="hidden card p-8 text-center">
        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-10 h-10 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
              d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
              clip-rule="evenodd" />
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">No encontramos tu cita</h3>
        <p class="text-gray-600 mb-6">Verifica tus datos o contacta al consultorio</p>
        <button onclick="volverBusqueda()" class="btn-primary">Intentar de nuevo</button>
      </div>

      <!-- Cita encontrada -->
      <div id="detalleCita" class="hidden">

        <!-- Estado de pago -->
        <div id="alertaPago" class="card p-4 mb-6 border-2 border-orange-300 bg-orange-50">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 flex items-center justify-center flex-shrink-0">
              <svg class="w-8 h-8 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                  clip-rule="evenodd" />
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="font-bold text-orange-800 mb-1">Pago pendiente</h3>
              <p class="text-sm text-orange-700 mb-3">Completa tu pago en las pr√≥ximas 3 horas para confirmar tu cita
              </p>
              <a href="#" id="linkPagoDetalle" target="_blank"
                class="inline-flex items-center gap-2 bg-orange-600 text-white px-6 py-2 rounded-lg font-semibold text-sm hover:bg-orange-700">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" />
                  <path fill-rule="evenodd"
                    d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"
                    clip-rule="evenodd" />
                </svg>
                <span>Pagar ahora</span>
              </a>
            </div>
          </div>
        </div>

        <div id="alertaPagado" class="hidden card p-4 mb-6 border-2 border-green-300 bg-green-50">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 flex items-center justify-center flex-shrink-0">
              <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clip-rule="evenodd" />
              </svg>
            </div>
            <div>
              <h3 class="font-bold text-green-800 mb-1">Pago confirmado</h3>
              <p class="text-sm text-green-700">Tu cita est√° confirmada. Te esperamos en la fecha indicada.</p>
            </div>
          </div>
        </div>

        <!-- FOLIO -->
        <div class="folio-display mb-6">
          <p class="text-xs font-semibold text-blue-900 mb-1">FOLIO</p>
          <div class="folio-number" id="folioDetalle">-</div>
        </div>

        <!-- Detalles de la cita -->
        <div class="card p-6 mb-6">
          <h3 class="text-xl font-bold text-gray-900 mb-6">Detalles de tu cita</h3>

          <div class="space-y-4">
            <div class="flex items-start gap-3 pb-4 border-b">
              <div class="info-icon">
                <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                    clip-rule="evenodd" />
                </svg>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">PACIENTE</p>
                <p class="font-semibold text-gray-900" id="nombrePacienteDetalle">-</p>
              </div>
            </div>

            <div class="flex items-start gap-3 pb-4 border-b">
              <div class="info-icon">
                <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                    clip-rule="evenodd" />
                </svg>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">FECHA Y HORA</p>
                <p class="font-semibold text-gray-900" id="fechaHoraDetalle">-</p>
              </div>
            </div>

            <div class="flex items-start gap-3 pb-4 border-b">
              <div class="info-icon" id="iconoTipoDetalle">
                <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z"
                    clip-rule="evenodd" />
                </svg>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">TIPO DE CONSULTA</p>
                <p class="font-semibold text-gray-900" id="tipoConsultaDetalle">-</p>
              </div>
            </div>

            <div class="flex items-start gap-3 pb-4 border-b">
              <div class="info-icon">
                <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                  <path fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z"
                    clip-rule="evenodd" />
                </svg>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">COSTO</p>
                <p class="text-2xl font-bold text-blue-600" id="costoDetalle">-</p>
              </div>
            </div>

            <div class="flex items-start gap-3 pb-4 border-b">
              <div class="info-icon">
                <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                </svg>
              </div>
              <div class="flex-1">
                <p class="text-xs text-gray-500 mb-1">MOTIVO</p>
                <p class="text-sm text-gray-700" id="motivoDetalle">-</p>
              </div>
            </div>

            <div class="flex items-start gap-3">
              <div class="info-icon">
                <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                </svg>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">CONTACTO</p>
                <p class="text-sm text-gray-700" id="contactoDetalle">-</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Informaci√≥n adicional -->
        <div class="card p-4 mb-6 bg-blue-50 border border-blue-200">
          <h4 class="font-semibold text-blue-900 mb-3 flex items-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                clip-rule="evenodd" />
            </svg>
            <span>Ubicaci√≥n del consultorio</span>
          </h4>
          <p class="text-sm text-blue-800 mb-1"><strong>Hospital Aranda de la Parra</strong></p>
          <p class="text-sm text-blue-800 mb-1">Calle M. Hidalgo 329, Centro</p>
          <p class="text-sm text-blue-800 mb-3">37000 Le√≥n, Guanajuato</p>
          <p class="text-sm text-blue-800 mb-3"><strong>Consultorio 303 | 3¬∞ Piso, Torre B</strong></p>
          <p class="text-xs text-blue-700 flex items-start gap-2">
            <svg class="w-4 h-4 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path
                d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.34.208-.646.477-.859a4 4 0 10-4.954 0c.27.213.462.519.476.859h4.002z" />
            </svg>
            <span><strong>Importante:</strong> Llega 10 minutos antes de tu cita</span>
          </p>
        </div>

        <!-- T√©rminos y condiciones -->
        <div class="card p-4 mb-6 bg-amber-50 border border-amber-200">
          <h4 class="font-semibold text-amber-900 mb-3 flex items-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                clip-rule="evenodd" />
            </svg>
            <span>Pol√≠tica de cancelaci√≥n y t√©rminos</span>
          </h4>
          <ul class="text-xs text-amber-800 space-y-2">
            <li class="flex items-start gap-2">
              <span class="text-amber-600 font-bold">‚Ä¢</span>
              <span>Las cancelaciones deben realizarse con <strong>al menos 24 horas de anticipaci√≥n</strong>.</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-amber-600 font-bold">‚Ä¢</span>
              <span>La cita est√° <strong>sujeta a confirmaci√≥n de pago</strong> en las pr√≥ximas 3 horas.</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-amber-600 font-bold">‚Ä¢</span>
              <span>Cancelaciones con menos de 24 horas <strong>o inasistencias sin previo aviso no habr√°
                  reembolso</strong></span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-amber-600 font-bold">‚Ä¢</span>
              <span>Por favor, <strong>trae tus estudios previos</strong> (si los tienes) y una lista de medicamentos
                que tomas actualmente.</span>
            </li>
          </ul>
        </div>

        <!-- Acciones -->
        <div class="space-y-3">
          <button onclick="compartirCita()" class="btn-secondary w-full flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path
                d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
            </svg>
            <span>Compartir por WhatsApp</span>
          </button>

          <button onclick="mostrarCancelar()" id="btnCancelar" class="btn-danger w-full">
            Cancelar cita
          </button>

          <button onclick="volverBusqueda()" class="btn-secondary w-full">
            Buscar otra cita
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de cancelaci√≥n -->
    <div id="modalCancelar"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="card p-6 max-w-md w-full">
        <h3 class="text-xl font-bold text-gray-900 mb-4">¬øCancelar cita?</h3>
        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-sm text-red-800 mb-2"><strong>‚ö†Ô∏è Importante:</strong></p>
          <ul class="text-xs text-red-700 space-y-1">
            <li>‚Ä¢ Si cancelas con menos de 24 horas, <strong>perder√°s el pago</strong>.</li>
            <li>‚Ä¢ Las citas tienen semanas de espera debido a la alta demanda.</li>
            <li>‚Ä¢ Esta acci√≥n <strong>no se puede deshacer</strong>.</li>
          </ul>
        </div>
        <p class="text-gray-600 mb-6">¬øEst√°s seguro de que deseas cancelar?</p>
        <div class="flex gap-3">
          <button onclick="cerrarModalCancelar()"
            class="flex-1 px-6 py-3 border-2 border-gray-200 rounded-lg font-semibold text-gray-700">
            No, mantener
          </button>
          <button onclick="confirmarCancelacion()" class="flex-1 btn-danger">
            S√≠, cancelar
          </button>
        </div>
      </div>
    </div>

  </main>

  <script>
    const { createClient } = supabase;

    const supabaseClient = createClient(
      'https://ecqjfftvvcyqpxtdcnbb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjcWpmZnR2dmN5cXB4dGRjbmJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MDA5NjQsImV4cCI6MjA4MDI3Njk2NH0.hQ94vABAfutXKRB0boBet-HcnR-VW6Lin6IRUeKEl6o'
    );

    const STRIPE_LINKS = {
      normal: 'https://buy.stripe.com/eVqfZg5iq9uw3ub80ddAk03',
      urgente: 'https://buy.stripe.com/5kQaEWaCKfSU3ub2FTdAk04',
      subsecuente: 'https://buy.stripe.com/dRmcN44em8qs9Sz6W9dAk05'
    };

    let citaActual = null;

    // Buscar cita
    document.getElementById('formBuscarCita').addEventListener('submit', async (e) => {
      e.preventDefault();

      const telefono = document.getElementById('inputTelefonoBuscar').value.trim();
      const folio = document.getElementById('inputFolio').value.trim();

      let cita = null;

      if (folio) {
        // Buscar por folio
        const { data } = await supabaseClient
          .from('citas')
          .select('*')
          .eq('folio', folio)
          .single();
        cita = data;
      } else if (telefono && telefono.length === 10) {
        // Buscar por tel√©fono - obtener la m√°s pr√≥xima
        const { data } = await supabaseClient
          .from('citas')
          .select('*')
          .eq('telefono', telefono)
          .gte('fecha', new Date().toISOString().split('T')[0])
          .order('fecha')
          .order('horario')
          .limit(1);
        cita = data?.[0];
      }

      if (cita) {
        mostrarDetalleCita(cita);
      } else {
        mostrarSinCitas();
      }
    });

    function mostrarDetalleCita(cita) {
      citaActual = cita;

      const tipos = {
        normal: 'Consulta General',
        urgente: 'Consulta Urgente',
        video: 'Consulta Subsecuente'
      };

      const precios = {
        normal: '$1,100',
        urgente: '$1,800',
        video: '$600'
      };

      const iconos = {
        normal: 'üè•',
        urgente: 'üö®',
        video: 'üìã'
      };

      // Ocultar b√∫squeda, mostrar resultado
      document.getElementById('busquedaCita').classList.add('hidden');
      document.getElementById('resultadoCita').classList.remove('hidden');
      document.getElementById('detalleCita').classList.remove('hidden');
      document.getElementById('sinCitas').classList.add('hidden');

      // Estado de pago
      if (cita.pagado) {
        document.getElementById('alertaPago').classList.add('hidden');
        document.getElementById('alertaPagado').classList.remove('hidden');
      } else {
        document.getElementById('alertaPago').classList.remove('hidden');
        document.getElementById('alertaPagado').classList.add('hidden');
        document.getElementById('linkPagoDetalle').href = STRIPE_LINKS[cita.tipo];
      }

      // Verificar si puede cancelar (24 horas antes)
      const fechaCita = new Date(`${cita.fecha}T${cita.horario}`);
      const ahora = new Date();
      const horasRestantes = (fechaCita - ahora) / (1000 * 60 * 60);

      const btnCancelar = document.getElementById('btnCancelar');
      if (horasRestantes < 24) {
        btnCancelar.disabled = true;
        btnCancelar.classList.add('opacity-50', 'cursor-not-allowed');
        btnCancelar.innerHTML = 'No se puede cancelar (menos de 24h)';
      } else {
        btnCancelar.disabled = false;
        btnCancelar.classList.remove('opacity-50', 'cursor-not-allowed');
        btnCancelar.innerHTML = 'Cancelar cita';
      }

      // Llenar detalles
      document.getElementById('folioDetalle').textContent = cita.folio || 'N/A';
      document.getElementById('nombrePacienteDetalle').textContent = cita.nombre;
      document.getElementById('fechaHoraDetalle').textContent =
        `${formatearFecha(cita.fecha)} ‚Ä¢ ${cita.horario.substring(0, 5)}`;
      document.getElementById('tipoConsultaDetalle').textContent = tipos[cita.tipo];
      document.getElementById('iconoTipoDetalle').textContent = iconos[cita.tipo];
      document.getElementById('costoDetalle').textContent = precios[cita.tipo];
      document.getElementById('motivoDetalle').textContent = cita.motivo;
      document.getElementById('contactoDetalle').textContent =
        `${cita.telefono}${cita.email ? ' ‚Ä¢ ' + cita.email : ''}`;
    }

    function mostrarSinCitas() {
      document.getElementById('busquedaCita').classList.add('hidden');
      document.getElementById('resultadoCita').classList.remove('hidden');
      document.getElementById('sinCitas').classList.remove('hidden');
      document.getElementById('detalleCita').classList.add('hidden');
    }

    function volverBusqueda() {
      document.getElementById('busquedaCita').classList.remove('hidden');
      document.getElementById('resultadoCita').classList.add('hidden');
      document.getElementById('formBuscarCita').reset();
      citaActual = null;
    }

    function formatearFecha(fechaISO) {
      const fecha = new Date(fechaISO + 'T00:00:00');
      const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

      return `${dias[fecha.getDay()]} ${fecha.getDate()} de ${meses[fecha.getMonth()]} ${fecha.getFullYear()}`;
    }

    function compartirCita() {
      if (!citaActual) return;

      const tipos = {
        normal: 'Consulta General',
        urgente: 'Consulta Urgente',
        video: 'Videollamada'
      };

      const mensaje = `
üè• *Mi cita con Dra. Jaznelly Lesso Zamora*

Paciente: ${citaActual.paciente}
üìÖ Fecha: ${formatearFecha(citaActual.fecha)}
üïê Hora: ${citaActual.horario.substring(0, 5)}
üíº Tipo: ${tipos[citaActual.tipo]}
üî¢ Folio: ${citaActual.folio}

üìç Hospital Aranda de la Parra
Consultorio 303, Torre B
Le√≥n, Guanajuato

      `.trim();

      const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
    }

    function mostrarCancelar() {
      if (!citaActual) return;

      const fechaCita = new Date(`${citaActual.fecha}T${citaActual.horario}`);
      const ahora = new Date();
      const horasRestantes = (fechaCita - ahora) / (1000 * 60 * 60);

      if (horasRestantes < 24) {
        alert('‚ö†Ô∏è No puedes cancelar tu cita con menos de 24 horas de anticipaci√≥n. Si no puedes asistir, perder√°s el pago realizado.');
        return;
      }

      document.getElementById('modalCancelar').classList.remove('hidden');
    }

    function cerrarModalCancelar() {
      document.getElementById('modalCancelar').classList.add('hidden');
    }

    async function confirmarCancelacion() {
      if (!citaActual) return;

      const { error } = await supabaseClient
        .from('citas')
        .delete()
        .eq('id', citaActual.id);

      if (!error) {
        alert('‚úÖ Tu cita ha sido cancelada exitosamente');
        volverBusqueda();
        cerrarModalCancelar();
      } else {
        alert('‚ùå Error al cancelar. Por favor contacta al consultorio: 477 101 1668');
      }
    }
  </script>
</body>

</html>