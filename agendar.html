<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendar Cita - Dra. Jaznelly Lesso Zamora</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap');

    * {
      font-family: 'DM Sans', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: #f8fafc;
    }

    h1,
    h2,
    h3 {
      font-family: 'Playfair Display', serif;
    }

    .progress-bar {
      height: 4px;
      background: #e2e8f0;
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      transition: width 0.3s ease;
    }

    .step-indicator {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
    }

    .step-indicator.active {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .step-indicator.inactive {
      background: #e2e8f0;
      color: #64748b;
    }

    .step-indicator.completed {
      background: #10b981;
      color: white;
    }

    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
    }

    .card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .option-card {
      border: 2px solid #e2e8f0;
      transition: all 0.2s;
      cursor: pointer;
    }

    .option-card:hover {
      border-color: #cbd5e1;
      transform: translateY(-2px);
    }

    .option-card.selected {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .calendar-mini {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .day-cell {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .day-cell:hover:not(.disabled):not(.blocked) {
      background: #f1f5f9;
    }

    .day-cell.selected {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
      font-weight: 600;
    }

    .day-cell.disabled {
      color: #cbd5e1;
      cursor: not-allowed;
    }

    .day-cell.blocked {
      background: #fee2e2;
      color: #dc2626;
      cursor: not-allowed;
      position: relative;
    }

    .day-cell.blocked::after {
      content: '√ó';
      position: absolute;
      top: 2px;
      right: 2px;
      font-size: 10px;
    }

    .day-cell.availability-full {
      background: white;
      border: 2px solid #e2e8f0;
    }

    .day-cell.availability-low {
      background: #fcd34d;
      border: 2px solid #f59e0b;
      color: #92400e;
    }

    .day-cell.availability-none {
      background: #fca5a5;
      border: 2px solid #dc2626;
      color: #7f1d1d;
    }

    .time-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
    }

    .time-slot {
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .time-slot:hover:not(.disabled) {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .time-slot.selected {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border-color: transparent;
      color: white;
    }

    .time-slot.disabled {
      background: #f8fafc;
      color: #cbd5e1;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
      font-weight: 600;
      padding: 14px 28px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
      background: white;
      color: #475569;
      font-weight: 600;
      padding: 14px 28px;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      border-color: #cbd5e1;
      background: #f8fafc;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    nav {
      backdrop-filter: blur(20px) saturate(180%);
      background: rgba(255, 255, 255, 0.9);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.05);
    }

    @media (max-width: 640px) {
      .day-cell {
        font-size: 12px;
      }

      .time-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .folio-display {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 2px solid #3b82f6;
      padding: 20px;
      border-radius: 16px;
      text-align: center;
      margin-bottom: 24px;
    }

    .folio-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: #1e40af;
      font-family: 'DM Sans', monospace;
      letter-spacing: 2px;
    }

    .tab-btn {
      background: #f1f5f9;
      color: #64748b;
      transition: all 0.2s;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }

    .tab-btn:hover {
      background: #e2e8f0;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="bg-white border-b sticky top-0 z-50">
    <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
      <div>
        <h1 class="text-lg font-bold text-gray-900">Dra. Jaznelly Lesso Zamora</h1>
        <p class="text-xs text-gray-500">Oftalmolog√≠a</p>
      </div>
      <div class="flex gap-3">
        <a href="index.html" class="text-sm text-gray-600 font-semibold hover:text-gray-900">Inicio</a>
        <a href="consultar.html" class="text-sm text-blue-600 font-semibold hover:text-blue-700">Consultar</a>
        <button id="btnAdmin" class="text-sm text-gray-400 font-semibold hover:text-gray-600">Admin</button>
      </div>
    </div>
  </header>

  <!-- Contenedor Principal -->
  <main class="max-w-4xl mx-auto px-4 py-6 pb-24">

    <!-- VISTA: Reservar Cita -->
    <div id="vistaReserva">

      <!-- Progreso -->
      <div class="mb-8">
        <div class="flex justify-between items-center mb-3">
          <div class="flex items-center gap-2">
            <div class="step-indicator active" id="stepInd1">1</div>
            <span class="text-sm font-medium text-gray-700">Fecha</span>
          </div>
          <div class="flex-1 h-1 bg-gray-200 mx-2"></div>
          <div class="flex items-center gap-2">
            <div class="step-indicator inactive" id="stepInd2">2</div>
            <span class="text-sm font-medium text-gray-400">Hora</span>
          </div>
          <div class="flex-1 h-1 bg-gray-200 mx-2"></div>
          <div class="flex items-center gap-2">
            <div class="step-indicator inactive" id="stepInd3">3</div>
            <span class="text-sm font-medium text-gray-400">Datos</span>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressBar" style="width: 33.33%"></div>
        </div>
      </div>

      <!-- Paso 1: Fecha -->
      <div id="paso1" class="fade-in">
        <div class="flex items-center justify-between mb-6">
          <div class="w-24"></div>
          <div class="text-center">
            <h2 class="text-xl font-bold text-gray-900">Selecciona la fecha</h2>
            <p class="text-sm text-gray-500" id="mesNombre">Enero 2025</p>
          </div>
          <div class="w-24"></div>
        </div>

        <div class="card p-4">
          <div class="flex justify-between items-center mb-4">
            <button id="prevMes" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-gray-100">
              ‚Üê
            </button>
            <span class="font-semibold text-gray-900" id="mesActual2">Enero 2025</span>
            <button id="nextMes" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-gray-100">
              ‚Üí
            </button>
          </div>

          <div class="calendar-mini mb-2">
            <div class="text-center text-xs font-semibold text-gray-500 py-2">D</div>
            <div class="text-center text-xs font-semibold text-gray-500 py-2">L</div>
            <div class="text-center text-xs font-semibold text-gray-500 py-2">M</div>
            <div class="text-center text-xs font-semibold text-gray-500 py-2">M</div>
            <div class="text-center text-xs font-semibold text-gray-500 py-2">J</div>
            <div class="text-center text-xs font-semibold text-gray-500 py-2">V</div>
            <div class="text-center text-xs font-semibold text-gray-500 py-2">S</div>
          </div>

          <div class="calendar-mini" id="calendarioDias">
            <!-- Generado din√°micamente -->
          </div>

          <!-- Banner de disponibilidad mejorado -->
          <div class="mt-6 pt-6 border-t border-gray-200">
            <p class="text-sm font-bold text-gray-800 mb-4 flex items-center gap-2">

              Disponibilidad de horarios
            </p>
            <div class="space-y-2">
              <div class="flex items-center gap-3 p-3 bg-emerald-50 rounded-lg border border-emerald-200">
                <div class="w-8 h-8 rounded-lg border-2 border-emerald-400 bg-white flex items-center justify-center">
                  <svg class="w-5 h-5 text-emerald-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                      d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                      clip-rule="evenodd"></path>
                  </svg>
                </div>
                <div class="flex-1">
                  <p class="text-sm font-semibold text-emerald-900">Disponible</p>
                  <p class="text-xs text-emerald-700">3 o m√°s horarios</p>
                </div>
              </div>

              <div class="flex items-center gap-3 p-3 bg-amber-50 rounded-lg border border-amber-200">
                <div
                  class="w-8 h-8 rounded-lg border-2 border-amber-400 bg-yellow-300 flex items-center justify-center">
                  <svg class="w-5 h-5 text-amber-900" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                      d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                      clip-rule="evenodd"></path>
                  </svg>
                </div>
                <div class="flex-1">
                  <p class="text-sm font-semibold text-amber-900">Poca disponibilidad</p>
                  <p class="text-xs text-amber-700">1 a 2 horarios</p>
                </div>
              </div>

              <div class="flex items-center gap-3 p-3 bg-red-50 rounded-lg border border-red-200">
                <div class="w-8 h-8 rounded-lg border-2 border-red-400 bg-red-300 flex items-center justify-center">
                  <svg class="w-5 h-5 text-red-700" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                      d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                      clip-rule="evenodd"></path>
                  </svg>
                </div>
                <div class="flex-1">
                  <p class="text-sm font-semibold text-red-900">Lleno</p>
                  <p class="text-xs text-red-700">Sin horarios disponibles</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Paso 2: Hora -->
      <div id="paso2" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <button id="btnBack2" class="btn-secondary">‚Üê Atr√°s</button>
          <div class="text-center">
            <h2 class="text-xl font-bold text-gray-900">Elige tu horario</h2>
            <p class="text-sm text-gray-500" id="fechaSeleccionada">-</p>
          </div>
          <div class="w-24"></div>
        </div>

        <!-- Banner informativo de precios -->
        <div class="card p-4 mb-4 bg-blue-50 border border-blue-200">
          <p class="text-sm font-semibold text-blue-900 mb-3">üí° Tipos de Consulta y Precios</p>
          <div class="space-y-3">
            <div class="flex justify-between items-start gap-4">
              <div class="flex-1">
                <span class="text-sm text-blue-800"><strong> Consulta General</strong></span>
                <p class="text-xs text-blue-700 mt-1">Revisi√≥n completa y diagn√≥stico (40 min)</p>
              </div>
              <span class="text-sm font-bold text-blue-900 whitespace-nowrap">$1,100</span>
            </div>
            <div class="flex justify-between items-start gap-4">
              <div class="flex-1">
                <span class="text-sm text-blue-800"><strong> Consulta Subsecuente</strong></span>
                <p class="text-xs text-blue-700 mt-1">Interpretaci√≥n de estudios ‚Ä¢ Consultas subsecuentes dentro del
                  mismo mes ‚Ä¢ Programaci√≥n de cirug√≠as, previa valoraci√≥n inicial (30 min)</p>
                <p class="text-xs text-blue-800 font-bold mt-1 bg-blue-100 px-2 py-1 rounded inline-block">Se te
                  otorgar√° un c√≥digo</p>
              </div>
              <span class="text-sm font-bold text-blue-900 whitespace-nowrap">$600</span>
            </div>
            <div class="flex justify-between items-start gap-4">
              <div class="flex-1">
                <span class="text-sm text-blue-800"><strong>
                    Consulta Urgente</strong></span>
                <p class="text-xs text-blue-700 mt-1">Atenci√≥n prioritaria inmediata (60 min)</p>
              </div>
              <span class="text-sm font-bold text-blue-900 whitespace-nowrap">$1,800</span>
            </div>
          </div>
        </div>

        <!-- Secci√≥n Consulta General -->
        <div class="mb-6">
          <h3 class="text-lg font-bold text-gray-900 mb-3 flex items-center gap-2">
            <span></span> Consulta General - $1,100
          </h3>
          <div class="card p-4">
            <div id="horariosGeneralContainer" class="time-grid">
              <!-- Generado din√°micamente -->
            </div>
          </div>
        </div>

        <!-- Secci√≥n Consulta Urgente -->
        <div>
          <h3 class="text-lg font-bold text-gray-900 mb-3 flex items-center gap-2">
            <span></span> Consulta Urgente - $1,800
          </h3>
          <div class="card p-4">
            <div id="horariosUrgentContainer" class="time-grid">
              <!-- Generado din√°micamente -->
            </div>
          </div>
        </div>
      </div>

      <!-- Paso 3: Datos -->
      <div id="paso3" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <button id="btnBack3" class="btn-secondary">‚Üê Atr√°s</button>
          <h2 class="text-xl font-bold text-gray-900">Tus datos</h2>
          <div class="w-24"></div>
        </div>

        <form id="formDatos" class="space-y-4">
          <div class="card p-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Tel√©fono * <span
                class="text-xs text-gray-500">(10 d√≠gitos)</span></label>
            <input type="tel" id="inputTelefono" required maxlength="10" pattern="[0-9]{10}"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg" placeholder="4491234567">
            <p class="text-xs text-gray-500 mt-1">Ingresa tu tel√©fono para buscar tus datos</p>
          </div>

          <div id="indicadorBusqueda" class="hidden card p-3 bg-blue-50 border border-blue-200">
            <p class="text-sm text-blue-700 flex items-center gap-2">
              <svg class="w-5 h-5 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <span>Buscando tus datos...</span>
            </p>
          </div>

          <div id="mensajePacienteEncontrado" class="hidden card p-3 bg-green-50 border border-green-200">
            <p class="text-sm text-green-700 flex items-center gap-2">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clip-rule="evenodd" />
              </svg>
              <span>¬°Te encontramos! Solo confirma tu motivo de consulta</span>
            </p>
          </div>

          <div class="card p-4" id="campoNombre">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre *</label>
            <input type="text" id="inputNombre" required
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg uppercase" placeholder="JUAN"
              style="text-transform: uppercase;">
          </div>

          <div class="card p-4" id="campoApellidoPaterno">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Apellido Paterno *</label>
            <input type="text" id="inputApellidoPaterno" required
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg uppercase" placeholder="P√âREZ"
              style="text-transform: uppercase;">
          </div>

          <div class="card p-4" id="campoApellidoMaterno">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Apellido Materno *</label>
            <input type="text" id="inputApellidoMaterno" required
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg uppercase" placeholder="GARC√çA"
              style="text-transform: uppercase;">
          </div>

          <div class="card p-4" id="campoEmail">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Email <span
                class="text-xs text-gray-500">(opcional)</span></label>
            <input type="email" id="inputEmail" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg"
              placeholder="tu@email.com">
          </div>

          <div class="card p-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Motivo de consulta *</label>
            <textarea id="inputMotivo" required rows="4" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg"
              placeholder="Describe tu situaci√≥n..."></textarea>
          </div>

          <button type="submit" class="btn-primary w-full">
            Confirmar reserva ‚Üí
          </button>
        </form>
      </div>

      <!-- Paso 5: Confirmaci√≥n -->
      <div id="confirmacion" class="hidden">
        <div class="text-center mb-6">
          <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-12 h-12 text-green-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                clip-rule="evenodd" />
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-gray-900 mb-2">¬°Cita confirmada!</h2>
          <p class="text-gray-600">Tu reserva ha sido guardada</p>
        </div>

        <!-- FOLIO -->
        <div class="folio-display">
          <p class="text-sm font-semibold text-blue-900 mb-2">TU FOLIO DE CITA</p>
          <div class="folio-number" id="folioDisplay">-</div>
          <p class="text-xs text-blue-700 mt-2">Guarda este folio para consultar tu cita</p>
        </div>

        <div class="card p-6 mb-4">
          <div class="space-y-4">
            <div>
              <p class="text-xs text-gray-500 mb-1">FECHA Y HORA</p>
              <p class="font-bold text-lg" id="resumenFecha">-</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 mb-1">TIPO</p>
              <p class="font-semibold" id="resumenTipo">-</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 mb-1">TOTAL</p>
              <p class="text-3xl font-bold text-blue-600" id="resumenPrecio">-</p>
            </div>
          </div>
        </div>

        <!-- Alerta de tiempo l√≠mite din√°mica -->
        <div class="card p-4 bg-amber-50 border border-amber-200 mb-4">
          <p class="text-sm text-amber-800 text-center flex items-center justify-center gap-2">
            <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                clip-rule="evenodd" />
            </svg>
            <span id="mensajeTiempoLimite"><strong>Tienes 5 horas</strong> para completar tu pago</span>
          </p>
        </div>

        <!-- Dos botones de pago -->
        <p class="text-sm font-semibold text-gray-700 mb-3 text-center">Elige c√≥mo pagar:</p>
        <div class="space-y-3 mb-4">
          <!-- Bot√≥n Tarjeta -->
          <button id="btnPagarTarjeta"
            class="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold py-4 px-6 rounded-xl hover:from-blue-700 hover:to-indigo-700 transition-all shadow-md hover:shadow-lg">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
              <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" />
              <path fill-rule="evenodd"
                d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"
                clip-rule="evenodd" />
            </svg>
            <div class="text-left">
              <div class="text-base">üí≥ Pagar con tarjeta</div>
              <div class="text-xs opacity-80">Visa, Mastercard, Amex</div>
            </div>
          </button>

          <!-- Bot√≥n Oxxo -->
          <button id="btnPagarOxxo"
            class="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-red-500 to-orange-500 text-white font-semibold py-4 px-6 rounded-xl hover:from-red-600 hover:to-orange-600 transition-all shadow-md hover:shadow-lg">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm3 5a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm0 3a1 1 0 011-1h2a1 1 0 110 2H8a1 1 0 01-1-1z"
                clip-rule="evenodd" />
            </svg>
            <div class="text-left">
              <div class="text-base">üè™ Pagar en Oxxo</div>
              <div class="text-xs opacity-80">Genera tu voucher de pago ‚Ä¢ 24 horas</div>
            </div>
          </button>
        </div>

        <a href="consultar.html" class="btn-secondary w-full block text-center">
          Consultar mi cita
        </a>
      </div>

    </div>

    <!-- VISTA: Admin (Login simplificado) -->
    <div id="vistaAdmin" class="hidden">
      <div id="adminLogin">
        <div class="card p-6 max-w-sm mx-auto mt-12">
          <h2 class="text-2xl font-bold text-center mb-6">Admin</h2>
          <form id="formLogin" class="space-y-4">
            <input type="text" id="loginUser" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg"
              placeholder="Usuario">
            <input type="password" id="loginPass" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg"
              placeholder="Contrase√±a">
            <button type="submit" class="btn-primary w-full">Entrar</button>
            <button type="button" id="btnVolverLogin" class="btn-secondary w-full">Cancelar</button>
          </form>
        </div>
      </div>

      <div id="adminPanel" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold">Panel Admin</h2>
          <button id="btnCerrarSesion" class="text-sm text-red-600 font-semibold">Salir</button>
        </div>

        <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
          <button class="tab-btn active" data-tab="resumen">
            <svg class="w-4 h-4 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path
                d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
            </svg>
            Resumen
          </button>
          <button class="tab-btn" data-tab="pacientes">
            <svg class="w-4 h-4 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path
                d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
            </svg>
            Pacientes
          </button>
          <button class="tab-btn" data-tab="configuracion">
            <svg class="w-4 h-4 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                clip-rule="evenodd" />
            </svg>
            Configuraci√≥n
          </button>
        </div>

        <div id="tabResumen" class="tab-content">
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="card p-4">
              <p class="text-xs text-gray-500 mb-1">HOY</p>
              <p class="text-3xl font-bold" id="statHoy">0</p>
            </div>
            <div class="card p-4">
              <p class="text-xs text-gray-500 mb-1">SEMANA</p>
              <p class="text-3xl font-bold" id="statSemana">0</p>
            </div>
            <div class="card p-4">
              <p class="text-xs text-gray-500 mb-1">PENDIENTES</p>
              <p class="text-3xl font-bold text-orange-600" id="statPendientes">0</p>
            </div>
            <div class="card p-4">
              <p class="text-xs text-gray-500 mb-1">TOTAL</p>
              <p class="text-3xl font-bold" id="statTotal">0</p>
            </div>
          </div>

          <div class="card p-4 mb-6">
            <h3 class="font-bold mb-4">Pr√≥xima cita</h3>
            <div id="proximaCitaContent">
              <p class="text-gray-500 text-sm">No hay citas</p>
            </div>
          </div>

          <div class="card p-4">
            <div class="flex gap-2 mb-4">
              <input type="date" id="filtroFecha" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg text-sm">
              <button id="btnLimpiarFiltro" class="btn-secondary text-sm">Todas</button>
            </div>
            <div id="listaCitas"></div>
          </div>
        </div>

        <div id="tabPacientes" class="tab-content hidden">
          <div class="card p-4 mb-6">
            <h3 class="font-bold mb-4">Buscar paciente</h3>
            <div class="flex gap-2">
              <input type="text" id="inputBuscarPaciente" placeholder="Buscar por nombre, tel√©fono o folio..."
                class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg">
              <button id="btnBuscarPaciente" class="btn-primary px-6">Buscar</button>
            </div>
          </div>

          <div id="resultadosBusqueda" class="hidden">
            <div class="card p-4 mb-6">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <h3 class="text-xl font-bold" id="nombrePaciente">-</h3>
                  <p class="text-sm text-gray-600" id="contactoPaciente">-</p>
                </div>
                <button id="btnCerrarPaciente" class="text-gray-400 hover:text-gray-600">‚úï</button>
              </div>

              <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                  <p class="text-sm font-semibold text-gray-700">Historial de citas</p>
                  <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-semibold"
                    id="totalCitasPaciente">0 citas</span>
                </div>
                <div id="historialCitas" class="space-y-2 max-h-64 overflow-y-auto">
                  <!-- Generado din√°micamente -->
                </div>
              </div>
            </div>
          </div>

          <div id="sinResultados" class="hidden">
            <div class="card p-8 text-center">
              <p class="text-gray-500">No se encontraron pacientes</p>
            </div>
          </div>
        </div>

        <div id="tabConfiguracion" class="tab-content hidden">
          <div class="card p-4 mb-6">
            <h3 class="font-bold mb-4">Desbloquear jueves</h3>
            <p class="text-sm text-gray-600 mb-4">Los jueves est√°n bloqueados por defecto. Puedes habilitarlos aqu√≠:</p>
            <form id="formDesbloquearJueves" class="space-y-3">
              <input type="date" id="fechaDesbloquearJueves" required
                class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg">
              <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold">Habilitar
                jueves</button>
            </form>
          </div>

          <div class="card p-4 mb-6">
            <h3 class="font-bold mb-4">Bloquear d√≠a espec√≠fico</h3>
            <form id="formBloquearDia" class="space-y-3">
              <input type="date" id="fechaBloquearDia" required
                class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg">
              <input type="text" id="motivoBloqueo" placeholder="Motivo (opcional)"
                class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg">
              <button type="submit" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold">Bloquear
                d√≠a</button>
            </form>
          </div>

          <div class="card p-4">
            <h3 class="font-bold mb-4">D√≠as bloqueados manualmente</h3>
            <div id="listaDiasBloqueados"></div>
          </div>

          <div class="card p-4 mt-6">
            <h3 class="font-bold mb-4">Jueves habilitados</h3>
            <div id="listaJuevesHabilitados"></div>
          </div>

          <div class="card p-4 mt-6">
            <h3 class="font-bold mb-4">Bloquear horario espec√≠fico</h3>
            <p class="text-sm text-gray-600 mb-4">Bloquea un horario puntual en una fecha espec√≠fica sin bloquear todo
              el d√≠a.</p>
            <form id="formBloquearHorario" class="space-y-3">
              <input type="date" id="fechaBloquearHorario" required
                class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg">
              <select id="horarioBloquear" required class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg">
                <option value="">-- Selecciona un horario --</option>
                <optgroup label="Lunes / Mi√©rcoles / Jueves / Viernes">
                  <option value="10:00:00">10:00 (Urgente)</option>
                  <option value="11:00:00">11:00 (General)</option>
                  <option value="11:40:00">11:40 (General)</option>
                  <option value="12:20:00">12:20 (General)</option>
                  <option value="13:00:00">13:00 (General)</option>
                  <option value="13:40:00">13:40 (General)</option>
                  <option value="14:20:00">14:20 (Urgente)</option>
                </optgroup>
                <optgroup label="Martes">
                  <option value="16:00:00">16:00 (Urgente)</option>
                  <option value="17:00:00">17:00 (General)</option>
                  <option value="17:40:00">17:40 (General)</option>
                  <option value="18:20:00">18:20 (General)</option>
                  <option value="19:00:00">19:00 (General)</option>
                  <option value="19:40:00">19:40 (General)</option>
                  <option value="20:20:00">20:20 (Urgente)</option>
                </optgroup>
              </select>
              <input type="text" id="motivoBloqueoHorario" placeholder="Motivo (opcional)"
                class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg">
              <button type="submit" class="w-full bg-orange-600 text-white py-2 rounded-lg font-semibold">Bloquear
                horario</button>
            </form>
          </div>

          <div class="card p-4 mt-6">
            <h3 class="font-bold mb-4">Horarios bloqueados</h3>
            <div id="listaHorariosBloqueados"></div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <script>
    // ============================================
    // CONFIGURACI√ìN
    // ============================================
    const { createClient } = supabase;

    const supabaseClient = createClient(
      'https://ecqjfftvvcyqpxtdcnbb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjcWpmZnR2dmN5cXB4dGRjbmJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MDA5NjQsImV4cCI6MjA4MDI3Njk2NH0.hQ94vABAfutXKRB0boBet-HcnR-VW6Lin6IRUeKEl6o'
    );

    const STRIPE_LINKS = {
      normal: 'https://buy.stripe.com/eVqfZg5iq9uw3ub80ddAk03',
      urgente: 'https://buy.stripe.com/5kQaEWaCKfSU3ub2FTdAk04',
      subsecuente: 'https://buy.stripe.com/dRmcN44em8qs9Sz6W9dAk05',
      normal_oxxo: 'https://buy.stripe.com/bJe00i4emcGIggX6W9dAk07'
    };

    // Tiempos l√≠mite de pago por tipo y m√©todo
    const TIEMPO_LIMITE = {
      urgente_stripe: 2,
      normal_stripe: 5,
      oxxo: 24
    };

    // ============================================
    // SISTEMA DE FOLIOS
    // ============================================
    function generarFolio() {
      const fecha = new Date();
      const a√±o = fecha.getFullYear().toString().slice(-2);
      const mes = String(fecha.getMonth() + 1).padStart(2, '0');
      const dia = String(fecha.getDate()).padStart(2, '0');
      const hora = String(fecha.getHours()).padStart(2, '0');
      const minuto = String(fecha.getMinutes()).padStart(2, '0');
      const segundo = String(fecha.getSeconds()).padStart(2, '0');
      const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');

      return `${a√±o}${mes}${dia}-${hora}${minuto}${segundo}${random}`;
    }

    // Estado
    let currentStep = 1;
    let selectedType = null;
    let selectedDate = null;
    let selectedTime = null;
    let mesActual = new Date();
    let folioGenerado = null;
    let pacienteActualForm = null;
    let timeoutBusqueda = null;

    // ============================================
    // FUNCIONES DB
    // ============================================
    async function guardarCita(cita) {
      const { data, error } = await supabaseClient.from('citas').insert([cita]).select();
      if (error) { alert('Error al guardar'); return null; }
      return data[0];
    }

    async function obtenerCitas(fecha = null) {
      let query = supabaseClient.from('citas').select('*').order('fecha').order('horario');
      if (fecha) query = query.eq('fecha', fecha);
      const { data } = await query;
      return data || [];
    }

    async function obtenerDiasBloqueados() {
      const { data } = await supabaseClient.from('dias_bloqueados').select('*').order('fecha');
      return data || [];
    }

    async function obtenerJuevesHabilitados() {
      const { data } = await supabaseClient.from('jueves_habilitados').select('*').order('fecha');
      return data || [];
    }

    async function buscarPacientePorTelefono(telefono) {
      const { data } = await supabaseClient
        .from('pacientes')
        .select('*')
        .eq('telefono', telefono.trim())
        .single();
      return data;
    }

    async function upsertPaciente(paciente) {
      const { data, error } = await supabaseClient
        .from('pacientes')
        .upsert(paciente, { onConflict: 'telefono' })
        .select()
        .single();
      if (error) {
        console.error('Error al guardar paciente:', error);
        return null;
      }
      return data;
    }

    async function cancelarCitaDB(id) {
      await supabaseClient.from('citas').delete().eq('id', id);
    }

    async function marcarPagado(id) {
      await supabaseClient.from('citas').update({ pagado: true }).eq('id', id);
    }

    async function bloquearDia(bloqueo) {
      const { data, error } = await supabaseClient.from('dias_bloqueados').insert([bloqueo]).select();
      if (error) { alert('Error o ya bloqueado'); return null; }
      return data[0];
    }

    async function desbloquearDia(id) {
      await supabaseClient.from('dias_bloqueados').delete().eq('id', id);
    }

    async function habilitarJueves(fecha) {
      const { data, error } = await supabaseClient.from('jueves_habilitados').insert([{ fecha }]).select();
      if (error) { alert('Error o ya habilitado'); return null; }
      return data[0];
    }

    async function deshabilitarJueves(id) {
      await supabaseClient.from('jueves_habilitados').delete().eq('id', id);
    }

    async function obtenerHorariosBloqueados(fecha = null) {
      let query = supabaseClient.from('horarios_bloqueados').select('*').order('fecha').order('horario');
      if (fecha) query = query.eq('fecha', fecha);
      const { data } = await query;
      return data || [];
    }

    async function bloquearHorario(bloqueo) {
      const { data, error } = await supabaseClient.from('horarios_bloqueados').insert([bloqueo]).select();
      if (error) { alert('Error o ya bloqueado ese horario'); return null; }
      return data[0];
    }

    async function desbloquearHorario(id) {
      await supabaseClient.from('horarios_bloqueados').delete().eq('id', id);
    }

    async function buscarPaciente(termino) {
      const { data: pacientes } = await supabaseClient
        .from('pacientes')
        .select('*')
        .or(`nombre.ilike.%${termino}%,apellido_paterno.ilike.%${termino}%,apellido_materno.ilike.%${termino}%,telefono.ilike.%${termino}%`)
        .order('created_at', { ascending: false });

      if (pacientes && pacientes.length > 0) {
        const telefonos = pacientes.map(p => p.telefono);
        const { data: citas } = await supabaseClient
          .from('citas')
          .select('*')
          .in('telefono', telefonos)
          .order('fecha', { ascending: false });

        return citas || [];
      }

      // Buscar por folio
      const { data: citasPorFolio } = await supabaseClient
        .from('citas')
        .select('*')
        .ilike('folio', `%${termino}%`)
        .order('fecha', { ascending: false });

      return citasPorFolio || [];
    }

    // ============================================
    // VALIDACIONES
    // ============================================
    function validarTelefono(telefono) {
      const regex = /^[0-9]{10}$/;
      return regex.test(telefono.trim());
    }

    function validarEmail(email) {
      if (!email) return true;
      const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return regex.test(email);
    }

    function validarTexto(texto, minLength = 1) {
      return texto && texto.trim().length >= minLength;
    }

    function sanitizarTexto(texto) {
      return texto.trim().replace(/[<>"']/g, '');
    }

    // ============================================
    // UI STEPS
    // ============================================
    function showStep(step) {
      for (let i = 1; i <= 5; i++) {
        document.getElementById(`paso${i}`)?.classList.add('hidden');
        const ind = document.getElementById(`stepInd${i}`);
        if (ind) {
          ind.classList.remove('active', 'completed', 'inactive');
          if (i < step) ind.classList.add('completed');
          else if (i === step) ind.classList.add('active');
          else ind.classList.add('inactive');
        }
      }
      if (step <= 3) document.getElementById(`paso${step}`).classList.remove('hidden');
      const progress = (step / 3) * 100;
      document.getElementById('progressBar').style.width = `${progress}%`;
      currentStep = step;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ============================================
    // INICIAR EN PASO 1 (FECHA)
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      showStep(1);
    });

    // ============================================
    // PASO 2: CALENDARIO
    // ============================================
    async function getAvailabilityForDate(fechaStr) {
      const dateObj = new Date(fechaStr + 'T00:00:00');
      const diaSemana = dateObj.getDay();

      let horariosDisponibles = [];

      // Lunes (1), Mi√©rcoles (3), Jueves (4), Viernes (5)
      if (diaSemana === 1 || diaSemana === 3 || diaSemana === 4 || diaSemana === 5) {
        horariosDisponibles = ['11:00:00', '11:40:00', '12:20:00', '13:00:00', '13:40:00', '10:00:00', '14:20:00'];
      }
      // Martes (2)
      else if (diaSemana === 2) {
        horariosDisponibles = ['17:00:00', '17:40:00', '18:20:00', '19:00:00', '19:40:00', '16:00:00', '20:20:00'];
      }

      if (horariosDisponibles.length === 0) return 0;

      const citas = await obtenerCitas(fechaStr);
      const ocupados = citas.map(c => c.horario);
      const libres = horariosDisponibles.filter(h => !ocupados.includes(h)).length;

      return libres;
    }

    async function renderCalendar() {
      const year = mesActual.getFullYear();
      const month = mesActual.getMonth();
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

      document.getElementById('mesActual2').textContent = `${meses[month]} ${year}`;
      document.getElementById('mesNombre').textContent = `${meses[month]} ${year}`;

      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const bloqueados = await obtenerDiasBloqueados();
      const fechasBloqueadas = bloqueados.map(b => b.fecha);

      const juevesHabilitados = await obtenerJuevesHabilitados();
      const fechasJuevesHabilitados = juevesHabilitados.map(j => j.fecha);

      const container = document.getElementById('calendarioDias');
      container.innerHTML = '';

      for (let i = 0; i < firstDay; i++) container.appendChild(document.createElement('div'));

      for (let d = 1; d <= lastDate; d++) {
        const fecha = new Date(year, month, d);
        fecha.setHours(0, 0, 0, 0);
        const dow = fecha.getDay();
        const isWeekend = dow === 0 || dow === 6;
        const isPast = fecha < today;
        const fechaStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const isBlocked = fechasBloqueadas.includes(fechaStr);

        const isThursday = dow === 4;
        const isThursdayEnabled = fechasJuevesHabilitados.includes(fechaStr);
        const isThursdayBlocked = isThursday && !isThursdayEnabled;

        const cell = document.createElement('div');
        cell.textContent = d;
        cell.className = 'day-cell';

        if (isPast || isWeekend) {
          cell.classList.add('disabled');
        } else if (isBlocked || isThursdayBlocked) {
          cell.classList.add('blocked');
        } else {
          // Calcular disponibilidad
          const libres = await getAvailabilityForDate(fechaStr);

          if (libres === 0) {
            cell.classList.add('availability-none');
          } else if (libres <= 2) {
            cell.classList.add('availability-low');
          } else {
            cell.classList.add('availability-full');
          }

          cell.addEventListener('click', () => {
            selectedDate = fechaStr;
            document.querySelectorAll('.day-cell').forEach(c => c.classList.remove('selected'));
            cell.classList.add('selected');
            setTimeout(() => showStep(2), 300);
            renderHorarios();
          });
        }

        container.appendChild(cell);
      }
    }

    document.getElementById('prevMes').addEventListener('click', () => {
      mesActual.setMonth(mesActual.getMonth() - 1);
      renderCalendar();
    });

    document.getElementById('nextMes').addEventListener('click', () => {
      mesActual.setMonth(mesActual.getMonth() + 1);
      renderCalendar();
    });

    // ============================================
    // PASO 2: HORARIOS
    // ============================================
    async function renderHorarios() {
      document.getElementById('fechaSeleccionada').textContent = selectedDate;

      const citas = await obtenerCitas(selectedDate);
      const ocupados = citas.map(c => c.horario);

      // Obtener horarios bloqueados para esta fecha
      const horariosBloqueadosData = await obtenerHorariosBloqueados(selectedDate);
      const horariosBloqueados = horariosBloqueadosData.map(h => h.horario);

      const dateObj = new Date(selectedDate + 'T00:00:00');
      const diaSemana = dateObj.getDay();

      let horariosGeneral = [];
      let horariosUrgent = [];

      // Lunes (1), Mi√©rcoles (3), Jueves (4), Viernes (5)
      if (diaSemana === 1 || diaSemana === 3 || diaSemana === 4 || diaSemana === 5) {
        // Consulta General: 11:00 a 13:40 (40 min intervals)
        horariosGeneral = ['11:00:00', '11:40:00', '12:20:00', '13:00:00', '13:40:00'];
        // Consulta Urgente: 10:00 y 14:20
        horariosUrgent = ['10:00:00', '14:20:00'];
      }
      // Martes (2)
      else if (diaSemana === 2) {
        // Consulta General: 17:00 a 19:40 (40 min intervals)
        horariosGeneral = ['17:00:00', '17:40:00', '18:20:00', '19:00:00', '19:40:00'];
        // Consulta Urgente: 16:00 y 20:20
        horariosUrgent = ['16:00:00', '20:20:00'];
      }

      // Renderizar Consulta General
      const containerGeneral = document.getElementById('horariosGeneralContainer');
      containerGeneral.innerHTML = '';

      if (horariosGeneral.length === 0) {
        containerGeneral.innerHTML = '<p class="col-span-full text-center text-gray-500">No hay horarios disponibles</p>';
      } else {
        horariosGeneral.forEach(h => {
          const slot = document.createElement('div');
          slot.textContent = h.substring(0, 5);
          slot.className = 'time-slot';

          if (ocupados.includes(h) || horariosBloqueados.includes(h)) {
            slot.classList.add('disabled');
            if (horariosBloqueados.includes(h)) {
              slot.title = 'Horario bloqueado';
            }
          } else {
            slot.addEventListener('click', () => {
              selectedTime = h;
              selectedType = 'normal';
              document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
              slot.classList.add('selected');
              setTimeout(() => showStep(3), 300);
            });
          }

          containerGeneral.appendChild(slot);
        });
      }

      // Renderizar Consulta Urgente
      const containerUrgent = document.getElementById('horariosUrgentContainer');
      containerUrgent.innerHTML = '';

      if (horariosUrgent.length === 0) {
        containerUrgent.innerHTML = '<p class="col-span-full text-center text-gray-500">No hay horarios disponibles</p>';
      } else {
        horariosUrgent.forEach(h => {
          const slot = document.createElement('div');
          slot.textContent = h.substring(0, 5);
          slot.className = 'time-slot';

          if (ocupados.includes(h) || horariosBloqueados.includes(h)) {
            slot.classList.add('disabled');
            if (horariosBloqueados.includes(h)) {
              slot.title = 'Horario bloqueado';
            }
          } else {
            slot.addEventListener('click', () => {
              selectedTime = h;
              selectedType = 'urgente';
              document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
              slot.classList.add('selected');
              setTimeout(() => showStep(3), 300);
            });
          }

          containerUrgent.appendChild(slot);
        });
      }
    }

    // ============================================
    // PASO 3: AUTOCOMPLETADO
    // ============================================
    document.getElementById('inputTelefono').addEventListener('input', async (e) => {
      const telefono = e.target.value.trim();

      if (timeoutBusqueda) clearTimeout(timeoutBusqueda);

      document.getElementById('indicadorBusqueda').classList.add('hidden');
      document.getElementById('mensajePacienteEncontrado').classList.add('hidden');

      if (telefono.length === 10) {
        document.getElementById('indicadorBusqueda').classList.remove('hidden');

        timeoutBusqueda = setTimeout(async () => {
          const paciente = await buscarPacientePorTelefono(telefono);

          document.getElementById('indicadorBusqueda').classList.add('hidden');

          if (paciente) {
            pacienteActualForm = paciente;
            document.getElementById('mensajePacienteEncontrado').classList.remove('hidden');

            document.getElementById('inputNombre').value = paciente.nombre;
            document.getElementById('inputApellidoPaterno').value = paciente.apellido_paterno;
            document.getElementById('inputApellidoMaterno').value = paciente.apellido_materno;
            document.getElementById('inputEmail').value = paciente.email || '';

            document.getElementById('inputNombre').readOnly = true;
            document.getElementById('inputApellidoPaterno').readOnly = true;
            document.getElementById('inputApellidoMaterno').readOnly = true;

            document.getElementById('campoNombre').classList.add('opacity-75');
            document.getElementById('campoApellidoPaterno').classList.add('opacity-75');
            document.getElementById('campoApellidoMaterno').classList.add('opacity-75');

            document.getElementById('inputMotivo').focus();
          } else {
            pacienteActualForm = null;
            document.getElementById('inputNombre').value = '';
            document.getElementById('inputApellidoPaterno').value = '';
            document.getElementById('inputApellidoMaterno').value = '';
            document.getElementById('inputEmail').value = '';

            document.getElementById('inputNombre').readOnly = false;
            document.getElementById('inputApellidoPaterno').readOnly = false;
            document.getElementById('inputApellidoMaterno').readOnly = false;

            document.getElementById('campoNombre').classList.remove('opacity-75');
            document.getElementById('campoApellidoPaterno').classList.remove('opacity-75');
            document.getElementById('campoApellidoMaterno').classList.remove('opacity-75');
          }
        }, 500);
      }
    });

    // ============================================
    // PASO 4: FORM SUBMIT
    // ============================================
    document.getElementById('formDatos').addEventListener('submit', async (e) => {
      e.preventDefault();

      const telefono = document.getElementById('inputTelefono').value.trim();
      const nombre = document.getElementById('inputNombre').value.trim();
      const apellidoPaterno = document.getElementById('inputApellidoPaterno').value.trim();
      const apellidoMaterno = document.getElementById('inputApellidoMaterno').value.trim();
      const email = document.getElementById('inputEmail').value.trim();
      const motivo = document.getElementById('inputMotivo').value.trim();

      // Validaciones
      if (!validarTelefono(telefono)) {
        alert('‚ùå El tel√©fono debe tener exactamente 10 d√≠gitos num√©ricos');
        return;
      }

      if (!validarTexto(nombre, 2)) {
        alert('‚ùå El nombre debe tener al menos 2 caracteres');
        return;
      }

      if (!validarTexto(apellidoPaterno, 2)) {
        alert('‚ùå El apellido paterno debe tener al menos 2 caracteres');
        return;
      }

      if (!validarTexto(apellidoMaterno, 2)) {
        alert('‚ùå El apellido materno debe tener al menos 2 caracteres');
        return;
      }

      if (email && !validarEmail(email)) {
        alert('‚ùå El formato del email no es v√°lido');
        return;
      }

      if (!validarTexto(motivo, 10)) {
        alert('‚ùå El motivo de consulta debe tener al menos 10 caracteres');
        return;
      }

      // Sanitizar
      const nombreSanitizado = sanitizarTexto(nombre).toUpperCase();
      const apellidoPaternoSanitizado = sanitizarTexto(apellidoPaterno).toUpperCase();
      const apellidoMaternoSanitizado = sanitizarTexto(apellidoMaterno).toUpperCase();
      const emailSanitizado = email ? sanitizarTexto(email).toLowerCase() : null;
      const motivoSanitizado = sanitizarTexto(motivo);

      // Generar folio
      folioGenerado = generarFolio();

      // Crear paciente
      const paciente = await upsertPaciente({
        telefono,
        nombre: nombreSanitizado,
        apellido_paterno: apellidoPaternoSanitizado,
        apellido_materno: apellidoMaternoSanitizado,
        email: emailSanitizado
      });

      if (!paciente) {
        alert('‚ùå Error al guardar los datos del paciente. Intenta de nuevo.');
        return;
      }

      // Crear cita con FOLIO
      const cita = {
        paciente_id: paciente.id,
        folio: folioGenerado,
        nombre: `${nombreSanitizado} ${apellidoPaternoSanitizado} ${apellidoMaternoSanitizado}`,
        telefono,
        email: emailSanitizado,
        motivo: motivoSanitizado,
        fecha: selectedDate,
        horario: selectedTime,
        tipo: selectedType,
        pagado: false,
        metodo_pago: 'stripe'
      };

      const saved = await guardarCita(cita);
      if (saved) {
        const citaId = saved.id;
        const precios = { normal: '$1,100', urgente: '$1,800', video: '$600' };
        const tipos = { normal: 'Consulta General', urgente: 'Consulta Urgente', video: 'Consulta Subsecuente' };

        document.getElementById('folioDisplay').textContent = folioGenerado;
        document.getElementById('resumenFecha').textContent = `${selectedDate} ‚Ä¢ ${selectedTime.substring(0, 5)}`;
        document.getElementById('resumenTipo').textContent = tipos[selectedType];
        document.getElementById('resumenPrecio').textContent = precios[selectedType];

        // Tiempo l√≠mite din√°mico seg√∫n tipo (Oxxo se actualiza al hacer clic)
        const horasLimite = selectedType === 'urgente' ? 2 : 5;
        document.getElementById('mensajeTiempoLimite').innerHTML =
          `<strong>Tienes ${horasLimite} horas</strong> para completar tu pago con tarjeta, o <strong>24 horas</strong> si pagas en Oxxo`;

        // Bot√≥n Tarjeta: actualiza metodo_pago = 'stripe' y redirige con folio como referencia
        document.getElementById('btnPagarTarjeta').onclick = async () => {
          await supabaseClient.from('citas').update({ metodo_pago: 'stripe' }).eq('id', citaId);
          const url = `${STRIPE_LINKS[selectedType]}?client_reference_id=${folioGenerado}`;
          window.open(url, '_blank');
        };

        // Bot√≥n Oxxo: actualiza metodo_pago = 'oxxo' y redirige con folio como referencia
        document.getElementById('btnPagarOxxo').onclick = async () => {
          await supabaseClient.from('citas').update({ metodo_pago: 'oxxo' }).eq('id', citaId);
          const url = `${STRIPE_LINKS['normal_oxxo']}?client_reference_id=${folioGenerado}`;
          window.open(url, '_blank');
        };

        document.getElementById('paso3').classList.add('hidden');
        document.getElementById('confirmacion').classList.remove('hidden');

        document.getElementById('formDatos').reset();
        pacienteActualForm = null;
        document.getElementById('mensajePacienteEncontrado').classList.add('hidden');

        document.getElementById('inputNombre').readOnly = false;
        document.getElementById('inputApellidoPaterno').readOnly = false;
        document.getElementById('inputApellidoMaterno').readOnly = false;
        document.getElementById('campoNombre').classList.remove('opacity-75');
        document.getElementById('campoApellidoPaterno').classList.remove('opacity-75');
        document.getElementById('campoApellidoMaterno').classList.remove('opacity-75');
      }
    });

    // ============================================
    // NAVEGACI√ìN
    // ============================================
    document.getElementById('btnBack2').addEventListener('click', () => showStep(1));
    document.getElementById('btnBack3').addEventListener('click', () => showStep(2));

    // ============================================
    // ADMIN
    // ============================================
    document.getElementById('btnAdmin').addEventListener('click', () => {
      document.getElementById('vistaReserva').classList.add('hidden');
      document.getElementById('vistaAdmin').classList.remove('hidden');
    });

    document.getElementById('btnVolverLogin').addEventListener('click', () => {
      document.getElementById('vistaAdmin').classList.add('hidden');
      document.getElementById('vistaReserva').classList.remove('hidden');
    });

    async function validarAdminCredenciales(usuario, contrasena) {
      try {
        // Llamamos a la funci√≥n RPC en Postgres que verifica el hash (pgcrypto)
        const { data, error } = await supabaseClient.rpc('check_admin_credentials', {
          p_username: usuario,
          p_password: contrasena
        });

        if (error) {
          console.error('RPC error validando credenciales:', error);
          return false;
        }

        // data puede venir como true/false o como un objeto/array seg√∫n versi√≥n; normalizamos
        if (data === true || data === 't' || data === 1) return true;
        if (Array.isArray(data) && data.length > 0) {
          // Por si la funci√≥n devuelve rowset con boolean
          const v = data[0];
          if (v === true) return true;
          // si viene como { check_admin_credentials: true }
          const val = Object.values(v)[0];
          return !!val;
        }

        return false;
      } catch (err) {
        console.error('Error validando credenciales:', err);
        return false;
      }
    }

    document.getElementById('formLogin').addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = document.getElementById('loginUser').value.trim();
      const pass = document.getElementById('loginPass').value;

      if (!user || !pass) {
        alert('‚ö†Ô∏è Completa usuario y contrase√±a');
        return;
      }

      const credencialesValidas = await validarAdminCredenciales(user, pass);

      if (credencialesValidas) {
        document.getElementById('adminLogin').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('loginUser').value = '';
        document.getElementById('loginPass').value = '';
        await cargarAdmin();
      } else {
        alert('‚ùå Usuario o contrase√±a incorrectos');
      }
    });

    document.getElementById('btnCerrarSesion').addEventListener('click', () => {
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('adminLogin').classList.remove('hidden');
      document.getElementById('vistaAdmin').classList.add('hidden');
      document.getElementById('vistaReserva').classList.remove('hidden');
    });

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;

        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        if (tab === 'resumen') document.getElementById('tabResumen').classList.remove('hidden');
        if (tab === 'pacientes') document.getElementById('tabPacientes').classList.remove('hidden');
        if (tab === 'configuracion') document.getElementById('tabConfiguracion').classList.remove('hidden');
      });
    });

    async function cargarAdmin() {
      const citas = await obtenerCitas();
      const hoy = new Date().toISOString().split('T')[0];

      const citasHoy = citas.filter(c => c.fecha === hoy).length;
      const inicioSemana = new Date();
      inicioSemana.setDate(inicioSemana.getDate() - inicioSemana.getDay());
      const finSemana = new Date(inicioSemana);
      finSemana.setDate(finSemana.getDate() + 6);
      const citasSemana = citas.filter(c => {
        const f = new Date(c.fecha + 'T00:00:00');
        return f >= inicioSemana && f <= finSemana;
      }).length;
      const pendientes = citas.filter(c => !c.pagado).length;

      document.getElementById('statHoy').textContent = citasHoy;
      document.getElementById('statSemana').textContent = citasSemana;
      document.getElementById('statPendientes').textContent = pendientes;
      document.getElementById('statTotal').textContent = citas.length;

      await actualizarListaCitas();
      await actualizarProxima();
      await actualizarBloqueados();
      await actualizarJuevesHabilitados();
      await actualizarHorariosBloqueados();
    }

    async function actualizarListaCitas(filtro = null) {
      const container = document.getElementById('listaCitas');
      const citas = await obtenerCitas(filtro);

      if (citas.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Sin citas</p>';
        return;
      }

      const tipos = { normal: 'General', urgente: 'Urgente', video: 'Subsecuente' };
      const iconos = { normal: 'üè•', urgente: 'üö®', video: 'üìã' };

      container.innerHTML = citas.map(c => `
        <div class="border-b last:border-0 py-3">
          <div class="flex justify-between items-start mb-2">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <p class="font-semibold text-sm">${iconos[c.tipo]} ${c.nombre}</p>
                ${c.pagado ? '<span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded-full font-semibold">Pagado</span>' : '<span class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full font-semibold">Pendiente</span>'}
              </div>
              <p class="text-xs text-gray-500">${c.fecha} ‚Ä¢ ${c.horario.substring(0, 5)} ‚Ä¢ ${tipos[c.tipo]}</p>
              <p class="text-xs text-blue-600 font-mono">Folio: ${c.folio || 'N/A'}</p>
              <p class="text-xs text-gray-400 mt-1">${c.motivo}</p>
            </div>
          </div>
          <div class="flex gap-2">
            ${!c.pagado ? `<button onclick="marcarComoPagado(${c.id})" class="text-xs bg-green-600 text-white px-3 py-1 rounded-lg font-semibold">Marcar pagado</button>` : ''}
            <button onclick="cancelarCita(${c.id})" class="text-xs text-red-600 font-semibold">Cancelar</button>
          </div>
        </div>
      `).join('');
    }

    async function actualizarProxima() {
      const citas = await obtenerCitas();
      const ahora = new Date();
      const proxima = citas.find(c => new Date(`${c.fecha}T${c.horario}`) >= ahora);

      const container = document.getElementById('proximaCitaContent');

      if (proxima) {
        const tipos = { normal: 'General', urgente: 'Urgente', video: 'Subsecuente' };
        const iconos = { normal: 'üè•', urgente: 'üö®', video: 'üìã' };
        container.innerHTML = `
          <p class="font-bold">${iconos[proxima.tipo]} ${proxima.nombre}</p>
          <p class="text-sm text-gray-600">${proxima.fecha} ‚Ä¢ ${proxima.horario.substring(0, 5)}</p>
          <p class="text-xs text-blue-600 font-mono">Folio: ${proxima.folio || 'N/A'}</p>
          <p class="text-xs text-gray-500 mt-1">${proxima.motivo}</p>
          <p class="text-xs text-gray-400 mt-2 flex items-center gap-1">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
              <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
            </svg>
            ${proxima.telefono}
          </p>
        `;
      } else {
        container.innerHTML = '<p class="text-gray-500 text-sm">No hay pr√≥ximas</p>';
      }
    }

    window.cancelarCita = async function (id) {
      if (confirm('¬øCancelar esta cita?')) {
        await cancelarCitaDB(id);
        await cargarAdmin();
      }
    };

    window.marcarComoPagado = async function (id) {
      if (confirm('¬øMarcar como pagado?')) {
        await marcarPagado(id);
        await cargarAdmin();
      }
    };

    document.getElementById('filtroFecha').addEventListener('change', (e) => {
      actualizarListaCitas(e.target.value || null);
    });

    document.getElementById('btnLimpiarFiltro').addEventListener('click', () => {
      document.getElementById('filtroFecha').value = '';
      actualizarListaCitas();
    });

    // B√∫squeda de pacientes
    let pacienteActual = null;

    document.getElementById('btnBuscarPaciente').addEventListener('click', async () => {
      const termino = document.getElementById('inputBuscarPaciente').value.trim();
      if (!termino) {
        alert('Escribe un nombre, tel√©fono o folio');
        return;
      }

      const resultados = await buscarPaciente(termino);

      if (resultados.length === 0) {
        document.getElementById('resultadosBusqueda').classList.add('hidden');
        document.getElementById('sinResultados').classList.remove('hidden');
        return;
      }

      const paciente = resultados[0];
      pacienteActual = paciente;

      document.getElementById('sinResultados').classList.add('hidden');
      document.getElementById('resultadosBusqueda').classList.remove('hidden');

      document.getElementById('nombrePaciente').textContent = paciente.nombre;
      document.getElementById('contactoPaciente').textContent = `${paciente.telefono}${paciente.email ? ' ‚Ä¢ ' + paciente.email : ''}`;

      const historial = resultados.filter(c => c.telefono === paciente.telefono);
      document.getElementById('totalCitasPaciente').textContent = `${historial.length} cita${historial.length !== 1 ? 's' : ''}`;

      const tipos = { normal: 'General', urgente: 'Urgente', video: 'Subsecuente' };
      const iconos = { normal: 'üè•', urgente: 'üö®', video: 'üìã' };

      document.getElementById('historialCitas').innerHTML = historial.map(c => `
        <div class="p-3 bg-gray-50 rounded-lg">
          <div class="flex justify-between items-start mb-1">
            <p class="font-semibold text-sm">${iconos[c.tipo]} ${tipos[c.tipo]}</p>
            ${c.pagado ? '<span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded-full font-semibold">Pagado</span>' : '<span class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full font-semibold">Pendiente</span>'}
          </div>
          <p class="text-xs text-gray-500">${c.fecha} ‚Ä¢ ${c.horario.substring(0, 5)}</p>
          <p class="text-xs text-blue-600 font-mono">Folio: ${c.folio || 'N/A'}</p>
          <p class="text-xs text-gray-600 mt-1">${c.motivo}</p>
        </div>
      `).join('');
    });

    document.getElementById('btnCerrarPaciente').addEventListener('click', () => {
      document.getElementById('resultadosBusqueda').classList.add('hidden');
      document.getElementById('inputBuscarPaciente').value = '';
      pacienteActual = null;
    });

    // Configuraci√≥n
    document.getElementById('formDesbloquearJueves').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fecha = document.getElementById('fechaDesbloquearJueves').value;
      const fechaObj = new Date(fecha + 'T00:00:00');

      if (fechaObj.getDay() !== 4) {
        alert('‚ö†Ô∏è La fecha seleccionada no es jueves');
        return;
      }

      const result = await habilitarJueves(fecha);
      if (result) {
        await actualizarJuevesHabilitados();
        await renderCalendar();
        e.target.reset();
        alert('‚úÖ Jueves habilitado');
      }
    });

    document.getElementById('formBloquearDia').addEventListener('submit', async (e) => {
      e.preventDefault();
      const bloqueo = {
        fecha: document.getElementById('fechaBloquearDia').value,
        motivo: document.getElementById('motivoBloqueo').value || 'Sin motivo'
      };
      const result = await bloquearDia(bloqueo);
      if (result) {
        await actualizarBloqueados();
        await renderCalendar();
        e.target.reset();
        alert('‚úÖ D√≠a bloqueado');
      }
    });

    async function actualizarBloqueados() {
      const container = document.getElementById('listaDiasBloqueados');
      const bloqueados = await obtenerDiasBloqueados();

      if (bloqueados.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Sin bloqueos</p>';
        return;
      }

      container.innerHTML = bloqueados.map(b => `
        <div class="border-b last:border-0 py-3 flex justify-between items-center">
          <div>
            <p class="font-semibold text-sm">üìÖ ${b.fecha}</p>
            <p class="text-xs text-gray-500">${b.motivo}</p>
          </div>
          <button onclick="eliminarBloqueo(${b.id})" class="text-xs text-red-600 font-semibold">Quitar</button>
        </div>
      `).join('');
    }

    async function actualizarJuevesHabilitados() {
      const container = document.getElementById('listaJuevesHabilitados');
      const jueves = await obtenerJuevesHabilitados();

      if (jueves.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Ning√∫n jueves habilitado</p>';
        return;
      }

      container.innerHTML = jueves.map(j => `
        <div class="border-b last:border-0 py-3 flex justify-between items-center">
          <div>
            <p class="font-semibold text-sm">üìÖ ${j.fecha}</p>
            <p class="text-xs text-green-600">Jueves habilitado</p>
          </div>
          <button onclick="eliminarJuevesHabilitado(${j.id})" class="text-xs text-red-600 font-semibold">Deshabilitar</button>
        </div>
      `).join('');
    }

    window.eliminarBloqueo = async function (id) {
      if (confirm('¬øDesbloquear?')) {
        await desbloquearDia(id);
        await actualizarBloqueados();
        await renderCalendar();
      }
    };

    window.eliminarJuevesHabilitado = async function (id) {
      if (confirm('¬øDeshabilitar este jueves?')) {
        await deshabilitarJueves(id);
        await actualizarJuevesHabilitados();
        await renderCalendar();
      }
    };

    // Bloquear horario espec√≠fico
    document.getElementById('formBloquearHorario').addEventListener('submit', async (e) => {
      e.preventDefault();
      const bloqueo = {
        fecha: document.getElementById('fechaBloquearHorario').value,
        horario: document.getElementById('horarioBloquear').value,
        motivo: document.getElementById('motivoBloqueoHorario').value || 'Sin motivo'
      };
      const result = await bloquearHorario(bloqueo);
      if (result) {
        await actualizarHorariosBloqueados();
        e.target.reset();
        alert('‚úÖ Horario bloqueado');
      }
    });

    async function actualizarHorariosBloqueados() {
      const container = document.getElementById('listaHorariosBloqueados');
      const bloqueados = await obtenerHorariosBloqueados();

      if (bloqueados.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Sin horarios bloqueados</p>';
        return;
      }

      container.innerHTML = bloqueados.map(b => `
        <div class="border-b last:border-0 py-3 flex justify-between items-center">
          <div>
            <p class="font-semibold text-sm">üïê ${b.fecha} ‚Ä¢ ${b.horario.substring(0, 5)}</p>
            <p class="text-xs text-gray-500">${b.motivo}</p>
          </div>
          <button onclick="eliminarHorarioBloqueado(${b.id})" class="text-xs text-red-600 font-semibold">Quitar</button>
        </div>
      `).join('');
    }

    window.eliminarHorarioBloqueado = async function (id) {
      if (confirm('¬øDesbloquear este horario?')) {
        await desbloquearHorario(id);
        await actualizarHorariosBloqueados();
      }
    };

    // ============================================
    // INIT
    // ============================================
    window.addEventListener('load', () => {
      renderCalendar();
    });
  </script>
</body>

</html>